{"version":3,"file":"semantic-api.js","sources":["../src/semantic-api.ts"],"sourcesContent":["interface customFunc {\r\n    (method: string, data: string, args: any[], url: string): void\r\n}\r\n\r\ninterface customMethods {\r\n    [propName:string]: customFunc\r\n}\r\n\r\nclass SemanticApi {\r\n    public calls: string[]\r\n    private _proxy: any\r\n    private bondingStr: string\r\n    private waitForBonding: boolean\r\n    protected baseUrl: string\r\n    protected delimiter: string\r\n    protected methods: customMethods\r\n\r\n    /**\r\n     * @param {string} baseUrl the baseUrl that will be added at the start of url\r\n     * @param {object} customMethods key-value custom method function\r\n     */\r\n    constructor (baseUrl = '', customMethods = {}) {\r\n        this.calls = []\r\n        this.delimiter = '/'\r\n        this.baseUrl = baseUrl\r\n\r\n        this.methods = {\r\n            dot: function (method: string, data: any, args: any[], url: string) {\r\n                data === undefined ? this.bonding('.') : this.push(method, data, ...args)\r\n            },\r\n            slash: function (method: string, data: any, args: any[], url: string) {\r\n                data === undefined ? this.bonding('/') : this.push(method, data, ...args)\r\n            },\r\n            http: function (method: string, data: any, args: any[], url: string) {\r\n                data === undefined ? this.bonding('http://') : this.push(method, data, ...args)\r\n            },\r\n            https: function (method: string, data: any, args: any[], url: string) {\r\n                data === undefined ? this.bonding('https://') : this.push(method, data, ...args)\r\n            },\r\n            query: function (method: string, data: any, args: any[], url: string) {\r\n                if (data === undefined) {\r\n                    this.push(method, data, ...args)\r\n                } else {\r\n                    const prev = this.pop()\r\n                    const queryStringify = (opts: {[prop: string]: string|number} = {}) => Object.keys(opts).map(name => `${name}=${opts[name]}`).join('&')\r\n                    this.push(`${prev}?${queryStringify(data)}`)\r\n                }\r\n            }\r\n        }\r\n\r\n        this.methods = { ...this.methods, ...customMethods }\r\n        this._proxy = this._buildProxy()\r\n        return this._proxy\r\n    }\r\n\r\n    /**\r\n     * return is ES6-Proxy supported\r\n     */\r\n    _isSupportProxy () {\r\n        return typeof Proxy === 'function'\r\n    }\r\n\r\n    /**\r\n     * check is method exist and is it a function\r\n     * @param {string} methodName\r\n     */\r\n    _isMethod (methodName: string) {\r\n        return this.methods.hasOwnProperty(methodName) && typeof this.methods[methodName] === 'function'\r\n    }\r\n\r\n    /**\r\n     * build and return the new proxy instance\r\n     */\r\n    _buildProxy () {\r\n        // GoogleChrome/proxy-polyfill needs to ensure the property at creation time.\r\n        // Which is useless for our use case. And there is no other useable alternative choice.\r\n        if (!this._isSupportProxy()) {\r\n            throw new Error('Proxy is not supported in current environment.')\r\n        }\r\n\r\n        // Non-extensible object\r\n        const noop = Object.seal(() => {})\r\n        const handler = {\r\n            get: (target: any, property: string, receiver: any) => {\r\n                const reflectors = [\r\n                    'toString', 'valueOf', 'inspect', 'constructor',\r\n                    Symbol.toPrimitive,\r\n                    Symbol.for('util.inspect.custom'),\r\n                    // https://github.com/targos/node/commit/cc9898bd7747d2884afe9da8fff7e954225ba347\r\n                    Symbol.for('nodejs.util.inspect.custom')\r\n                ]\r\n                if (reflectors.includes(property)) return () => this.toString()\r\n\r\n                this.onGetProperty(property)\r\n                return this._proxy\r\n            },\r\n\r\n            apply: (target: any, receiver: any, args: any[]) => {\r\n                const methodName = this.pop()\r\n\r\n                if (this._isMethod(methodName)) {\r\n                    const value = args.shift()\r\n                    this.methods[methodName].call(this, methodName, value, args, this.toString())\r\n                } else {\r\n                    this.push(methodName, ...args)\r\n                }\r\n\r\n                return this._proxy\r\n            }\r\n        }\r\n\r\n        return new Proxy(noop, handler)\r\n    }\r\n\r\n    /**\r\n     * handler when proxy trap \"get\" triggered\r\n     * @param {string} property the property name being accessed\r\n     */\r\n    onGetProperty (property: string) {\r\n        if (this.waitForBonding) {\r\n            this.handleBonding(property)\r\n        } else {\r\n            this.push(property)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * push item to call list\r\n     * @param {string|number} item\r\n     * @param args\r\n     */\r\n    push (item: string|number, ...args: any[]) {\r\n        args = args.map(item => item && item.toString())\r\n        this.calls.push(item.toString(), ...args)\r\n    }\r\n\r\n    /**\r\n     * pop item from call list\r\n     */\r\n    pop (): string {\r\n        return this.calls.pop()\r\n    }\r\n\r\n    /**\r\n     * bonding previous and next property with bonding string\r\n     * @param {string} bondingStr the bonding string\r\n     */\r\n    bonding (bondingStr: string) {\r\n        this.bondingStr = bondingStr\r\n        this.waitForBonding = true\r\n    }\r\n\r\n    handleBonding (curr: string) {\r\n        const prev = this.pop() || ''\r\n        this.push(prev + this.bondingStr + curr)\r\n\r\n        this.waitForBonding = false\r\n    }\r\n\r\n    toString () {\r\n        return this.baseUrl + this.calls.join(this.delimiter) + (this.waitForBonding ? this.bondingStr : '')\r\n    }\r\n}\r\n\r\nmodule.exports = SemanticApi\r\n"],"names":["SemanticApi","constructor","baseUrl","customMethods","calls","delimiter","methods","dot","method","data","args","url","undefined","bonding","push","slash","http","https","query","prev","pop","queryStringify","opts","Object","keys","map","name","join","_proxy","_buildProxy","_isSupportProxy","Proxy","_isMethod","methodName","hasOwnProperty","Error","noop","seal","handler","get","target","property","receiver","reflectors","Symbol","toPrimitive","for","includes","toString","onGetProperty","apply","value","shift","call","waitForBonding","handleBonding","item","bondingStr","curr","module","exports"],"mappings":"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"}