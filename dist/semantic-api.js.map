{"version":3,"file":"semantic-api.js","sources":["../src/semantic-api.ts"],"sourcesContent":["interface customFunc {\r\n    (method: string, data: string, args: any[], url: string): void\r\n}\r\n\r\ninterface customMethods {\r\n    [propName:string]: customFunc\r\n}\r\n\r\nclass SemanticApi {\r\n    public calls: string[]\r\n    private _proxy: any\r\n    protected baseUrl: string\r\n    protected delimiter: string\r\n    protected methods: customMethods\r\n\r\n    /**\r\n     * @param {string} baseUrl the baseUrl that will be added at the start of url\r\n     * @param {object} customMethods key-value custom method function\r\n     */\r\n    constructor (baseUrl = '', customMethods = {}) {\r\n        this.calls = []\r\n        this.delimiter = '/'\r\n        this.baseUrl = baseUrl\r\n        this.methods = {\r\n            query: function (method: string, data: any, args: any[], url: string) {\r\n                if (data === undefined) {\r\n                    this.push(method)\r\n                } else {\r\n                    const prev = this.pop() || ''\r\n                    const queryStringify = (opts: {[prop: string]: string|number} = {}) => Object.keys(opts).map(name => `${name}=${opts[name]}`).join('&')\r\n                    this.push(`${prev}?${queryStringify(data)}`)\r\n                }\r\n            }\r\n        }\r\n\r\n        this.methods = { ...this.methods, ...customMethods }\r\n        this._proxy = this._buildProxy()\r\n        return this._proxy\r\n    }\r\n\r\n    /**\r\n     * return is ES6-Proxy supported\r\n     */\r\n    _isSupportProxy () {\r\n        return typeof Proxy === 'function'\r\n    }\r\n\r\n    /**\r\n     * check is method exist and is it a function\r\n     * @param {string} methodName\r\n     */\r\n    _isMethod (methodName: string) {\r\n        return this.methods.hasOwnProperty(methodName) && typeof this.methods[methodName] === 'function'\r\n    }\r\n\r\n    /**\r\n     * check is it a method that want to get our value\r\n     * @param {string} methodName\r\n     */\r\n    _isPeekingMethod (methodName: string) {\r\n        const reflectors = [\r\n            'toString', 'valueOf', 'inspect', 'constructor',\r\n            Symbol.toPrimitive,\r\n            Symbol.for('util.inspect.custom'),\r\n            // https://github.com/targos/node/commit/cc9898bd7747d2884afe9da8fff7e954225ba347\r\n            Symbol.for('nodejs.util.inspect.custom')\r\n        ]\r\n        return reflectors.includes(methodName)\r\n    }\r\n\r\n    /**\r\n     * handler when proxy trap get triggered\r\n     * @param {string} property the property/method name being accessed\r\n     */\r\n    onTrapTriggered (property: string, ...args: any[]) {\r\n        this.push(property, ...args)\r\n    }\r\n\r\n    _buildProxy () {\r\n        if (!this._isSupportProxy()) {\r\n            throw new Error('Proxy is not supported in current environment.')\r\n        }\r\n\r\n        // Non-extensible object\r\n        const noop = Object.seal(() => {})\r\n        const handler = {\r\n            get: (target: any, property: string, receiver: any) => {\r\n                if (this._isPeekingMethod(property)) {\r\n                    return () => this.toString()\r\n                }\r\n\r\n                this.onTrapTriggered(property)\r\n                return this._proxy\r\n            },\r\n\r\n            apply: (target: any, receiver: any, args: any[]) => {\r\n                const methodName = this.pop()\r\n\r\n                if (this._isMethod(methodName)) {\r\n                    const value = args.shift()\r\n                    let result = this.methods[methodName].call(this, methodName, value, args, this.toString())\r\n                    if (result !== undefined) return result\r\n                } else {\r\n                    this.onTrapTriggered(methodName, ...args)\r\n                }\r\n\r\n                return this._proxy\r\n            }\r\n        }\r\n\r\n        return new Proxy(noop, handler)\r\n    }\r\n\r\n    /**\r\n     * push item to call list\r\n     * @param {string|number} item\r\n     * @param args\r\n     */\r\n    push (item: string|number, ...args: any[]) {\r\n        if (args.length) args = args.map(arg => arg.toString())\r\n        this.calls.push(item.toString(), ...args)\r\n    }\r\n\r\n    /**\r\n     * pop item from call list\r\n     */\r\n    pop (): string {\r\n        return this.calls.pop()\r\n    }\r\n\r\n    toString () {\r\n        return this.baseUrl + this.calls.join(this.delimiter)\r\n    }\r\n}\r\n\r\nmodule.exports = SemanticApi\r\n"],"names":["SemanticApi","constructor","baseUrl","customMethods","calls","delimiter","methods","query","method","data","args","url","undefined","push","prev","pop","queryStringify","opts","Object","keys","map","name","join","_proxy","_buildProxy","_isSupportProxy","Proxy","_isMethod","methodName","hasOwnProperty","_isPeekingMethod","reflectors","Symbol","toPrimitive","for","includes","onTrapTriggered","property","Error","noop","seal","handler","get","target","receiver","toString","apply","value","shift","result","call","item","length","arg","module","exports"],"mappings":"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"}